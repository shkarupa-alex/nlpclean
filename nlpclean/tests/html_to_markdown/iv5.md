# Что нужно знать программисту про интеграцию сайта и 1С

* Немного теории
* Резюме
* Стандартные возможности обмена 1С и Битрикса
* Протокол
* Формат
* Алгоритм
* Подготовка к обмену
* Обмен товарами (1С -> Битрикс)
* Обмен справочниками (1С -> Битрикс)
* Формат файлов
* Формат файла обмена товарами
* Формат файла обмена предложениями
* Формат файла обмена ценами товаров и предложений
* Формат файла обмена остатками товаров и предложений
* Формат файла обмена справочниками
* Как дорабатывать обмен?
* Заключение

Нельзя просто взять и интегрировать сайт с 1С
Народное творчество

Считается, что интеграция 1С и сайта на Битриксе должна работать из коробки. Самые простые функции действительно можно запустить за час-два. А вот на доработку обмена можно потратить и 10, и 100 часов.

Доработка обмена сайта и 1С — это уже магия уровня «эксперт», пугает даже бородатого опытного разработчика. В этой статье мы поговорим о том, как происходит обмен данными между этими двумя монстрами и как можно расширять возможности этого обмена. Статья содержит множество технических деталей обмена и будет полезна в основном программистам, которые хотят разобраться в предмете.

В данной статье будет рассмотрена общая теория обмена между двумя IT-системами и два стандартных обмена между 1С и сайтом на 1С-Битрикс: обмен товарами и обмен справочниками.

## Немного теории

Интеграция — обмен информацией между двумя IT-системами. Иногда называют просто обмен. Определяется форматом данных, протоколом (стандартом) передачи данных, алгоритмом работы.

Формат = как выглядят данные (например, XML, YML, JSON, CSV).

Протокол = как данные оказываются в другом месте (например, HTTP, SIP, SMTP, FTP).

Алгоритм = что при этом происходит. Представляется блок-схемой или диаграммой UML Activity.

Примеры интеграций:

* обмен товарами между самописной учетной системой и сайтом (протокол FTP, формат CSV);
* парсинг курсов валюты с сайта ЦБ РФ (протокол HTTP, формат XML);
* интеграция сайта с Яндекс.Маркет (протокол HTTP, формат YML).

* Экспорт данных из системы А в требуемый формат;
* Передача данных;
* Импорт данных требуемого формата в систему Б.

И еще одно важное уточнение. «1С» — в зависимости от контекста, это может быть компания-легенда «ООО 1С», их разработка «1С:Предприятие» или конкретная конфигурация (например, «1С: Управление торговлей» или «1С:ERP Управление предприятием») с установленным модулем обмена с сайтом. В мире веб-разработки имеется в виду как раз последнее определение. В статье будет действовать аналогичное соглашение. Так же и с сайтом на платформе 1С-Битрикс: Управление сайтом — обычно это просто «Битрикс».

## Резюме

Интеграция — обмен данными между двумя системами.

Формат — как выглядят данные.

Протокол — как передаются данные.

1С — софт.

Битрикс — сайт.

Краткость — сестра.

## Стандартные возможности обмена 1С и Битрикса

«Из коробки» (без доработок программиста) работают 4 типа обмена:

* товары из 1С на сайт (тип «catalog»);
* справочники из 1С на сайт (тип «reference»);
* пользователей/контрагентов из 1С на сайт (тип «sale»);
* заказы (тип «sale»):
* из 1С на сайт;
* из сайта в 1С.

## Протокол

Все взаимодействия между 1С и Битриксом проводятся по HTTP, синхронно. Т.о. 1С подобна браузеру, она «открывает» специальную страницу, отправляет данные (методами POST и GET) и получает текстовый ответ. Есть даже способ имитировать выгрузку из 1С браузером (и мы часто используем этот трюк во время разработки и отладки). Подробнее про отладку мы рассказали в предыдущей статье «Типовые ошибки интеграции между 1С и 1С-Битрикс».

В терминах сетевых взаимодействий 1С — клиент, а сайт — сервер. Обращения всегда инициируются на стороне 1С. В 1С есть настройки адреса сайта, сайт про 1С не знает ничего.

Протокол синхронный. 1С отправляет следующий запрос на сайт только после получения ответа на предыдущий (или получения ошибки таймаута).

## Формат

Данные передаются в двух форматах.

Первый формат — текстовый для ответов сайта на запросы из 1С. Сайт выводит в первой строке ответа «success», если завершил некую процедуру, «progress», если продолжает ее выполнять и «error» или «failure», если была ошибка. В последующих строках могут быть дополнительные данные (зависит от каждого конкретного запроса).

Второй формат — CommerceML 2. Основан на XML, в этом формате передаются товары, предложения, цены, склады, заказы и контрагенты (пользователи+платежные профили).

## Алгоритм

## Подготовка к обмену

Выше мы уже сказали, что протокол обмена — синхронный HTTP. Все перечисленные типы обмена подразумевают выполнение нескольких запросов (шагов обмена) друг за другом. Первые два шага одинаковы для любого типа обмена, различия начинаются дальше

### Авторизация

| Запрос | Запрос |
| --- | --- |
| GET-параметры: | type=<тип обмена> |
| GET-параметры: | mode=checkauth |
| Basic access логин: | Логин сайта из настроек 1С |
| Basic access пароль: | Пароль сайта из настроек 1С |
| Ответ | Ответ |
| Если успех: | success  <имя Cookie авторизации>  <значение Cookie авторизации>  sessid=<ID сессии>  <параметр1>=<значение1>  <параметр2>=<значение2>  ... |
| Если ошибка: | failure  <текст ошибки> |

Любой обмен начинается с авторизации 1С на сайте методом Basic access. В случае успеха сайт выводит «success», имя и значение Cookie (которую будет проверять во всех последующих запросах), id сессии и прочие параметры (зависят от type — типа обмена).

#### Возможные ошибки

| Текст ошибки | Что делать |
| --- | --- |
| Ошибка авторизации. Неверное имя пользователя или пароль. | Проверить логин и пароль в Битрикс |
| У Вас нет прав для импорта каталога. Проверьте настройки компонента импорта. | Проверить права пользователя в Битрикс |
| Ошибка проверки источника запроса. Обновите модуль обмена или отключите проверку в настройках компонента | Обновить модуль обмена в 1С или выполнить php-код на сайте:  COption::SetOptionString("catalog", "DEFAULT\_SKIP\_SOURCE\_CHECK", "Y"); |
| Модуль Информационных блоков не установлен. | Проверить модуль iblock в Битрикс. Должен быть скачан и установлен |
| Включена смена идентификатора сессий. В файле подключения компонента обмена, до подключения пролога определите константу BX\_SESSION\_ID\_CHANGE: define('BX\_SESSION\_ID\_CHANGE', false); | Выполнить предложенное действие |
| Время на сервере базы данных отличается от времени на веб-сервере больше, чем на 10 минут. Вероятно неправильно настроены временные зоны. Выполните настройку и повторите обмен. | Проверить настройку часовых поясов на веб-сервере и на сервере БД |

### Запрос настроек сайта

| Запрос | Запрос |
| --- | --- |
| GET-параметры: | type=<тип обмена> |
| GET-параметры: | mode=init |
| GET-параметры: | sessid=<ID сессии> |
| Cookie: | <имя Cookie авторизации>=<значение Cookie авторизации> |
| Ответ | Ответ |
| Если успех: | zip=<yes|no>  file\_limit=<число> |

На этом шаге 1С узнает важные для обмена настройки сайта. Управление этими параметрами на сайте происходит на странице «Интеграция с 1С» в панели управления сайтом.

| Параметр | Назначение | Возможные значения |
| --- | --- | --- |
| zip | Сайт умеет распаковывать zip-архивы. Если yes — 1С будет загружать файлы обмена в архивах, что сильно экономит время и трафик. | yes  no |
| file\_limit | Максимально допустимый размер файла в байтах для передачи за один HTTP-запрос. Если системе 1С понадобится передать файл большего размера, они будут разбиты на несколько частей. | целое число >= 0 |

Получив эти параметры, 1С начинает формирование данных для передачи на сайт. Если «zip=yes», то все файлы будут переданы как zip-архив. Иначе каждый выгружается по отдельности. Желательно включать всегда.

#### Возможные ошибки

| Текст ошибки | Что делать |
| --- | --- |
| Ошибка инициализации временного каталога | При создании каталога для хранения файлов выгрузки произошла ошибка. Проверить права и путь для хранения файлов или закончилось место на диске. По умолчанию сайт складывает файлы в папку /upload/1c\_catalog/. |

## Обмен товарами (1С -> Битрикс)

Данный тип обмена (type=catalog) используется для создания и обновления на сайте следующих сущностей:

* инфоблок товаров;
* UF-поля разделов в этом инфоблоке;
* свойства элементов в этом инфоблоке;
* инфоблок SKU;
* типы цен;
* склады;
* разделы в инфоблоке товаров;
* элементы в инфоблоке товаров (товары);
* цены товаров;
* наличие товаров по складам.

При обмене товарами 1С формирует XML-файлы, передает их на сайт и контролирует их обработку сайтом. 1С может передать 4 вида файлов:

В файлах с префиксом import\_ — разделы каталога, товары, свойства товаров.

В файлах с префиксом offers\_ — SKU.

В файлах с префиксом prices\_ — цены товаров и предложений.

В файлах с префиксом rests\_ — остатки товаров и предложений по складам.

На шаге авторизации в случае успеха сервер вернет дополнительный параметр timestamp (текущее время). 1С сохранит timestamp и передаст на сайт на последнем шаге обмена товарами.

### Шаг 1. Передача файла (повторяющийся)

| Запрос | Запрос |
| --- | --- |
| GET-параметры: | type=catalog |
| GET-параметры: | mode=file |
| GET-параметры: | sessid=<ID сессии> |
| GET-параметры: | filename=<имя файла> |
| POST: | Содержимое файла в виде строки |
| Cookie: | <имя Cookie>=<значение Cookie> |
| Ответ | Ответ |
| Если успех: | success |
| Если ошибка: | failure  <текст ошибки> |

Шаг может выполняется несколько раз. Каждый файл выгружается частями не более file\_limit байт (см. предыдущий шаг) в бинарном виде через сырой POST-запрос. Сайт создает файл, если его нет. Имя файла берет из GET-параметра filename и дописывает в него переданный контент. Так продолжается до тех пор, пока 1С не передаст все части этого файла.

#### Возможные ошибки

| Текст ошибки | Что делать |
| --- | --- |
| Ошибка чтения HTTP данных | Проверить сетевое соединение между сайтом и 1С. |
| Ошибка открытия файла <имя файла> для записи | Проверить права на файл и папку файла у пользователя apache, под которыйм работает Битрикс. |
| Ошибка записи в файл <имя файла> | Проверить права на файл и папку файла у пользователя apache, под которыйм работает Битрикс. |

### Шаг 2. Основной

| Запрос | Запрос |
| --- | --- |
| GET-параметры: | type=<тип обмена> |
| GET-параметры: | mode=import |
| GET-параметры: | sessid=<ID сессии> |
| GET-параметры: | filename=<имя файла> |
| Cookie: | <имя Cookie>=<значение Cookie> |
| Ответ | Ответ |
| Если импорт завершен: | success |
| Если импорт продолжается: | progress  <текущий статус> |
| Если ошибка: | failure  <текст ошибки> |

Этот шаг — особенный. Файл уже целиком загружен на сайт и Битрикс готов его обработать. Его обработка может состоять из 11 более мелких операций, о которых 1С ничего не знает. Поэтому в параметре GET приходит mode=import (один и тот же запрос!), но сайт выполняет совершенно разные операции. Текущий прогресс Битрикс сохраняет в сессии в переменной $\_SESSION[BX\_CML2\_IMPORT][NS]. Например, узел STEP в этом массиве отвечает как раз за номер внутренней операции импорта.

#### Шаг 2.1 Распаковка архива (повторяющийся, необязательный)

| Ответ | Ответ |
| --- | --- |
| Если файл распакован: | progress  Распаковка архива завершена |
| Если файл распаковывается: | progress  Идет распаковка архива |
| Если ошибка: | failure  <текст ошибки> |

Шаг исполняется, только если 1С передала файл в формате ZIP. Распаковка происходит в той же директории, где лежат все файлы обмена товарами (по умолчанию — /upload/1c\_catalog/). Эта операция не нумеруется внутри Битрикса (значение STEP в сессии не изменяется).

##### Возможные ошибки

| Текст ошибки | Что делать |
| --- | --- |
| Ошибка распаковки архива | Проверьте работоспособность функции PHP zip\_open и расширение Zip. Если все корректно — скачайте архив с сайта и проверьте его корректность вручную. |

#### Шаг 2.2 Удаление временных таблиц

| Ответ | Ответ |
| --- | --- |
| Если успех: | progress  Временные таблицы удалены |
| Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) | Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) |
| STEP | 0 |

Работать напрямую с файлом XML (тем более, если он большой) неудобно и неэффективно. Поэтому все данные прочитываются во временную таблицу b\_xml\_tree. На этом подготовительном шаге таблица b\_xml\_tree, если она существует, удаляется.

#### Шаг 2.3 Создание временных таблиц

| Ответ | Ответ |
| --- | --- |
| Если успех: | progress  Временные таблицы созданы |
| Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) | Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) |
| STEP | 1 |

Таблица b\_xml\_tree создается. Если объявлена PHP константа BX\_XML\_CREATE\_INDEXES\_IMMEDIATELY, таблица сразу же индексируется. В конце этого шага Битрикс испускает событие OnBeforeCatalogImport1C.

##### Возможные ошибки

| Текст ошибки | Что делать |
| --- | --- |
| Ошибка создания временных таблиц | Проверить права и подключение СУБД. |

#### Шаг 2.4 Загрузка файла во временную таблицу (повторяющийся)

| Ответ | Ответ |
| --- | --- |
| Если файл читается: | progress  Обработано <число>% файла |
| Если файл прочтен: | progress  Файл импорта прочитан |
| Если ошибка: | failure  <текст ошибки> |
| Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) | Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) |
| STEP | 2 |

Битрикс шаг за шагом начинает читать переданный из 1С файл, добавляя записи в таблицу b\_xml\_tree. Чтобы избежать проблем с временем исполнения, процесс происходит пошагово. Управление продолжительностью шага происходит на странице «Интеграция с 1С» в панели управления сайтом.

##### Возможные ошибки

| Текст ошибки | Что делать |
| --- | --- |
| Ошибка открытия файла импорта | Проверить доступ к файлу |

#### Шаг 2.5 Индексация временных таблиц

| Ответ | Ответ |
| --- | --- |
| Если успех: | progress  Временные таблицы проиндексированы |
| Если ошибка: | failure  <текст ошибки> |
| Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) | Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) |
| STEP | 3 |

Для повышения скорости работы импорта таблица b\_xml\_tree индексируется после прочтения файла.

##### Возможные ошибки

| Текст ошибки | Что делать |
| --- | --- |
| Ошибка создания индекса для временных таблиц | Возможная причина: проблемы с СУБД, правами в ней или подключением. |

#### Шаг 2.6 Импорт метаданных

| Ответ | Ответ |
| --- | --- |
| Если успех: | progress  Метаданные импортированы успешно |
| Если ошибка: | failure  Ошибка импорта метаданных  <текст ошибки> |
| Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) | Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) |
| STEP | 4 |

На этом шаге создаются или обновляются следующие данные:

* Инфоблоки товаров и SKU
* Служебные свойства каталога (с префиксом CML2\_: CML2\_BAR\_CODE, CML2\_ARTICLE, CML2\_ATTRIBUTES…)
* Торговый каталог
* Свойства инфоблоков
* UF-поля разделов инфоблоков
* Типы цен
* Склады
* Единицы измерения

Важно: никакие сущности при импорте метаданных не удаляются. Случайно выгруженный из 1С склад или тип цены остается на сайте, пока администратор не удалит его вручную.

##### Возможные ошибки

| Текст ошибки | Что делать |
| --- | --- |
| Отсутствует модуль "Торговый каталог". Импорт торговых предложений и цен невозможен | Пояснения не требуются |
| Ошибка создания типа информационных блоков | После этого сообщения следует текст ошибки API, который пояснит причину ошибки. |
| Ошибка добавления новой единицы измерения (код единицы: <код>) | Текст ошибки Битрикс не выведет, необходимо разобрать XML файл самостоятельно и найти причину ошибки. |
| Количество импортированных складов превышает разрешенное для данной редакции | Пояснения не требуются |
| Ошибка импорта пользовательского свойства (xml\_id: <код>) | Проверить параметры пользовательского свойства |
| Название справочника должно начинаться с буквы и состоять только из латинских букв и цифр. | Пояснения не требуются |
| В выгрузке настроены цены с одинаковым названием. Продолжение обмена невозможно. | Пояснения не требуются |
| В редакции Малый Бизнес нет возможности иметь более одного типа цены. Настройте выгрузку из 1С или перейдите на другую редакцию БУС. | Пояснения не требуются |

#### Шаг 2.7 Импорт разделов каталога

| Ответ | Ответ |
| --- | --- |
| Если успех: | progress  Группы импортированы |
| Если ошибка: | failure  Ошибка импорта метаданных  <текст ошибки> |
| Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) | Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) |
| STEP | 5 |

На этом шаге в инфоблоке создаются и обновляются все разделы каталога, которые были в XML файле. Сопоставление разделов из XML-файла и в БД происходит по XML\_ID.

Если на сайте нет раздела с XML\_ID из файла, он создается. Если есть, то выполняется сравнение полей из XML файла с аналогичными полями в БД. Если изменения нет, то Битрикс только обновляет поле TIMESTAMP\_X и пропускает раздел. Если изменения есть — происходит полноценное обновление. Это происходит независимо от настроек сайта.

Для экономии ресурсов сервера добавление разделов происходит без пересчета дерева (речь о полях LEFT\_MARGIN и RIGHT\_MARGIN).

##### Возможные ошибки

Так как импорт разделов не пошаговый, при обмене большом дереве разделов на сайте может возникать ошибка превышения времени исполнения. Решения три.

* Увеличить время исполнения на странице «Интеграция с 1С» и в настройках сервера (nginx).
* Доработать 1С, чтобы ошибки на этом этапе игнорировались пока не будет получен ответ «progress».
* Повторить всю выгрузку несколько раз.

Объясним, как поможет повтор шага или всей выгрузки. Допустим, в XML-файле и на сайте 20001 раздел. Пусть за один проход Битрикс успевает импортировать только 10000 разделов.

| № Обмена/шага | Пропущено т.к. нет изменений | Обработано | Ответ |
| --- | --- | --- | --- |
| 1 | 0 | 10000 | Ошибка сервера |
| 2 | 10000 | 10000 | Ошибка сервера |
| 3 | 20000 | 1 | progress  Группы импортированы |

Битрикс каждый раз обрабатывает столько разделов, сколько успевает. При повторении выгрузки первые 10000 разделов он пропустит (обновит только TIMESTAMP\_X) и обновит еще 10000 разделов, пока не наступил таймаут. И только на 3-ей выгрузке из 1С шаг будет завершен корректно.

#### Шаг 2.8 Пересчет дерева разделов

| Ответ | Ответ |
| --- | --- |
| Если успех: | progress  Деактивация/удаление групп завершено |
| Если ошибка: | failure  Ошибка импорта метаданных  <текст ошибки> |
| Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) | Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) |
| STEP | 6 |

На этом шаге Битрикс выполняет две задачи:

* Удаление/деактивация разделов (в старых версиях модуля обмена в 1С)
* Перестройка дерева разделов

В старых версиях 1С отличить полную выгрузку от частичной просто: при частичной в узле «Классификатор» был атрибут СодержитТолькоИзменения="true", при полной его не было.

В 2019 году 1С всегда выгружает этот атрибут. Если этого атрибута нет, Битрикс мог (и до сих пор может, просто этот код не используется) удалить, деактивировать старые разделы (или пропустить их). На выбор влиял параметр на странице «Интеграция с 1С». Сейчас эта настройка уже ни на что не влияет и ни деактивации, ни удаления не происходит.

Также на этом шаге пересчитываются служебные поля LEFT\_MARGIN и RIGHT\_MARGIN всех разделов.

#### Шаг 2.9 Импорт товаров (повторяющийся)

| Ответ | Ответ |
| --- | --- |
| Если идет процесс импорта: | progress  Обработано <число> из <число> элементов |
| Если импорт завершен: | progress  Загрузка элементов завершена |
| Если ошибка: | failure  <текст ошибки> |
| Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) | Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) |
| STEP | 7 |
| DONE | Ассоциативный массив, счетчик обработанных товаров и всех товаров в файле |

На этом шаге в инфоблоке создаются и обновляются все товары, которые были в XML файле. Сопоставление товаров в файле товарам на сайте происходит по полю XML\_ID.

Если на сайте нет товара с XML\_ID из файла, он создается. Если есть, то выполняется сравнение полей из XML файла с аналогичными полями в БД.

Если изменения нет, и задан параметр «Использовать контрольные суммы элементов для оптимизации обновления каталога», Битрикс только обновляет поле TIMESTAMP\_X и пропускает товар. Иначе происходит полноценное обновление.

При импорте товара заполняется поле TMP\_ID. Значение для этого поля хранится в узле <НомерВерсии>. Если узла нет — Битрикс вычисляет контрольную сумму от всей информации о товаре из XML файла.

##### Возможные ошибки

| Текст ошибки | Что делать |
| --- | --- |
| Временная таблица не существует | Ошибка возникает если с сайтом работает несколько 1С или одна 1С присылает несколько запросов одновременно. В одном потоке выполняется шаг 4.9, а другой запустил шаг 4.2. |

#### Шаг 2.10 Деактивация/удаление товаров (повторяющийся)

| Ответ | Ответ |
| --- | --- |
| Если идет обработка: | progress  Обработано <число> из <число> элементов |
| Если обработка завершена: | progress  Деактивация/Удаление элементов завершены |
| Если ошибка: | failure  <текст ошибки> |
| Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) | Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) |
| STEP | 8 |
| DONE | Ассоциативный массив, счетчик обработанных товаров и всех товаров в файле |

На этом шаге раньше (как и на шаге 2.8 Пересчет дерева разделов) Битрикс проводил чистку товаров. Чистка товаров происходила только если в узле “Классификатор” XML файла не было пометки СодержитТолькоИзменения="true" (старый формат выгрузки). Есть аналогичная настройка для выбора, что делать с товарами.

В 2019 году на этом шаге ничего не происходит.

#### Шаг 2.11 Завершение импорта

| Ответ | Ответ |
| --- | --- |
| Если успех: | success  Импорт успешно завершен |
| Если ошибка: | failure  <текст ошибки> |
| Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) | Сессия ($\_SESSION[BX\_CML2\_IMPORT][NS]) |
| STEP | 9 |

Служебный шаг. Обработки данных нет, только испускается событие OnSuccessCatalogImport1C.

### Шаг 3. Деактивация старых данных

| Запрос | Запрос |
| --- | --- |
| GET-параметры: | type=<тип обмена> |
| GET-параметры: | mode=deactivate |
| GET-параметры: | sessid=<ID сессии> |
| GET-параметры: | timestamp=<время на сервере> |
| Cookie: | <имя Cookie>=<значение Cookie> |
| Ответ | Ответ |
| Если успех: | success  Деактивация элементов завершена |
| Если ошибка: | failure  Ошибка деактивации элементов |

На этом шаге в 2019 году Битрикс деактивирует все товары и разделы каталога, не затронутые в текущей сессии. Для этого время последнего изменения сравнивается с timestamp, который передает 1С — время начала текущей сессии, полученное на шаге авторизации.

Напомним, что эти настройки в панели управления сайта сейчас ни на что не влияют (всегда происходит деактивация):

Этот шаг будет выполнен, только если современная 1С делает полную выгрузку. Для выгрузки изменений и в старых версиях 1С этого шага нет.

### Шаг 4. Завершение импорта

| Запрос | Запрос |
| --- | --- |
| GET-параметры: | type=<тип обмена> |
| GET-параметры: | mode=complete |
| GET-параметры: | sessid=<ID сессии> |
| Cookie: | <имя Cookie>=<значение Cookie> |
| Ответ | Ответ |
| Если успех: | success  Завершение процедуры импорта |
| Если ошибка: | failure  <текст ошибки> |

Служебный шаг. Обработки данных нет, только испускается недокументированное событие модуля catalog OnCompleteCatalogImport1C. Аргументы обработчика аналогичны обработчикам события OnSuccessCatalogImport1C, возвращаемого значения нет.

## Обмен справочниками (1С -> Битрикс)

Данный тип обмена (type=reference) используется для создания и обновления на сайте HL-блоков. Этот тип намного короче чем обмен товарами и повторяет многие из его шагов.

Часто обмен справочниками — простой и быстрый способ расширить стандартные функции обмена.

### Шаг 1. Передача файла (повторяющийся)

см. аналогичный шаг обмена товарами, (отличается только mode, в данном типе обмена mode=reference).

### Шаг 2. Основной

| Запрос | Запрос |
| --- | --- |
| GET-параметры: | type=reference |
| GET-параметры: | mode=import |
| GET-параметры: | sessid=<ID сессии> |
| Cookie: | <имя Cookie>=<значение Cookie> |

#### Шаг 2.1 Распаковка архива (повторяющийся, необязательный)

см. аналогичный шаг обмена товарами.

#### Шаг 2.2 Подготовка справочника

| Ответ | Ответ |
| --- | --- |
| Если успех: | progress  Найден или создан справочник. Код справочника: <ID> |
| Если ошибка: | failure  <текст ошибки> |

На этом шаге Битрикс создает HL-блок (если не существует) и все UF-поля. В начале шага испускается событие модуля catalog OnBeforeCatalogImportHL. Событие недокументированное, в обработчики передаются массив параметров компонента и путь к XML-файлу. Обработчик может вызвать ошибку и вернуть произвольное сообщение.

Важно знать следующие особенности импорта справочников:

* 1С не может удалить справочник или поле, только создать;
* 1С может создать только поля следующих типов: Строка, Булево, Дата, Число;
* все поля, создаваемые 1С будут одиночными, необязательными, скрытыми в фильтре, показанными и редактируемыми в таблице;
* Битрикс автоматически создает поля: UF\_NAME, UF\_XML\_ID, UF\_VERSION, UF\_DESCRIPTION.

##### Возможные ошибки

| Текст ошибки | Что делать |
| --- | --- |
| Ошибка при создании поля в справочнике <Текст ошибки> | Изучить текст и исправить в 1С или на сайте |
| Ошибка при создании справочника <Текст ошибки> | Изучить текст и исправить в 1С или на сайте |
| Ошибка разбора XML. Код ошибки: <Код ошибки> | Расшифровать код и исправить в 1С или на сайте |

Расшифровка кодов ошибок.

| Код | Объяснение |
| --- | --- |
| 10 | Неизвестная ошибка парсинга XML файла |
| 20 | Невалидный XML файл |
| 110 | В XML файле отсутствует или пустой узел <Ид> справочника |
| 120 | В XML файле отсутствует или пустой узел <Наименование> справочника |
| 210 | Во время импорта UF-полей не был найден higloadblock |
| 220 | В XML файле отсутствует или пустой узел <Ид> в <Реквизит> |
| 230 | В XML файле отсутствует или пустой узел <Наименование> в <Реквизит> |
| 240 | Неизвестный <ТипЗначений> в узле <Реквизит> (допустимы только: Строка, Булево, Дата, Число) |
| 250 | Неизвестная ошибка при создании UF-поля highload блока |
| 310 | Во время элементов справочника не был найден higloadblock |
| 320 | В XML файле отсутствует или пустой узел <Ид> в <ЭлементСправочника> |
| 330 | В XML файле отсутствует или пустой узел <ЗначениеРеквизита> в <ЗначенияРеквизитов> в <ЭлементСправочника> |

#### Шаг 2.3 Импорт элементов (повторяющийся)

| Ответ | Ответ |
| --- | --- |
| Если импорт завершен: | success  Импорт успешно завершен |
| Если импорт в процессе: | progress  Импортировано элементов: <число> |
| Если ошибка: | failure  <текст ошибки> |

На этом шаге Битрикс импортирует все элементы HL-блока.

Если выгрузка была полной, Битрикс удаляет все элементы HL-блока, у которых значение поля UF\_VERSION не начинается с <ID текущей сессии> + «#»

В конце шага Битрикс испускает событие модуля catalog OnSuccessCatalogImportHL. Аргументы — массив параметров компонента и путь к файлу.

##### Возможные ошибки

Аналогичны ошибкам на предыдущем шаге.

## Формат файлов

## Формат файла обмена товарами

Официальная документация Битрикса по файлу обмена товарами (с примером): https://dev.1c-bitrix.ru/api\_help/sale/xml/import.php

## Формат файла обмена предложениями

Официальная документация Битрикса по файлу обмена предложениями (с примером): https://dev.1c-bitrix.ru/api\_help/sale/xml/offers.php

## Формат файла обмена ценами товаров и предложений

Официальная документация Битрикса по файлу обмена ценами (с примером): https://dev.1c-bitrix.ru/api\_help/sale/xml/prices.php

## Формат файла обмена остатками товаров и предложений

Официальная документация Битрикса по файлу обмена остатками (с примером): https://dev.1c-bitrix.ru/api\_help/sale/xml/rests.php

## Формат файла обмена справочниками

Официальная документация Битрикса по файлу обмена справочниками (с примером): https://dev.1c-bitrix.ru/api\_help/sale/xml/references.php.

Поясним некоторые места этого XML.

* Узел <Ид>
* Значение становится названием сущности (после транслитерации).
* С префиксом «b\_» становится названием таблицы (после транслитерации).
* Узел <Наименование> Не используется. Вообще. Но если узла не будет в файле, Битрикс выдаст ошибку (sic!)
* Каждый <Реквизит> описывается тремя узлами:
* <Ид>
* Значение становится XML ID поля
* С префиксом «UF\_» становится кодом поля
* <Наименование>
* Значение становится названием UF-поля.
* <ТипЗначений>
* 4 допустимых значения: Строка, Булево, Дата, Число
* Каждый <ЭлементСправочника> описывается полями:
* <Ид>
* Становится значением поля UF\_XML\_ID
* <НомерВерсии>
* C префиксом <ID текущей сессии> + «#» становится значением поля UF\_VERSION
* <ЗначенияРеквизитов>
* Реквизит Код
* Становится значением поля UF\_NAME
* Реквизит Наименование
* Становится значением поля UF\_DESCRIPTION
* Реквизит ПометкаУдаления
* Не используется
* Прочие реквизиты
* Поля типа «Дата» представлены в формате YYYY-MM-DD HH:MI:SS.
* Поля типа «Булево» представлены строками true или false (или пустой строкой).

## Как дорабатывать обмен?

Все запросы (при стандартном обмене) 1С присылает на служебную страницу /bitrix/admin/1c\_exchange.php. Но если заглянуть в файл, выяснится что вся логика скрыта в недрах модуля «Торговый каталог» в файле /bitrix/modules/sale/admin/1c\_exchange.php. Эти страницу нельзя изменять, но можно скопировать (обычно мы копируем в /bitrix/admin/1c\_exchange\_custom.php) и изменить адрес в 1С.

На этой странице, в зависимости от переданных GET-параметров (совсем как комплексные компоненты в режиме не-ЧПУ) подключаются разные простые компоненты. Компоненты без шаблонов.

Значительная часть логики вынесена из этих компонентов в классы. Связь видов обмена, GET-параметров, компонентов и основных классов приведена ниже в таблице.

| Тип данных | GET[type] | Компонент | Класс с логикой | Путь к классу |
| --- | --- | --- | --- | --- |
| Заказы, контрагенты | sale | bitrix:sale.export.1c | \CSaleOrderLoader | /bitrix/modules/sale/general/order\_loader.php |
| Товары, предложения, склады, цены, наличие | catalog | bitrix:catalog.import.1c | \CIBlockCMLImport | /bitrix/modules/iblock/classes/general/cml2.php |
| Справочники | reference | bitrix:catalog.import.hl | \CBitrixCatalogImportHl | В папке с компонентом |

Существует 3 принципиально разных способа доработать обмен с 1С:

* Не трогать стандартный обмен, использовать обработчики событий.
* Кастомизировать файлы обмена на стороне сайта и доработать по требованиям
* Выгружать нужные данные как справочники и обрабатывать самостоятельно.

Первый способ нужен для самых простых случаев, ничего серьезного сделать так не получится.

Второй способ реализуется так:

* Создать собственную страницу обмена. Обычно это /bitrix/admin/1c\_exchange\_custom.php.
* На эту страницу перенести код из /bitrix/modules/sale/admin/1c\_exchange.php.
* Кастомизировать нужный компонент обмена и заменить вызов системного компонента на вызов собственного (например, bitrix:catalog.import.1c на intervolga:catalog.import.1c) на новой странице обмена.
* Может понадобиться изменение логики класса. Используйте наследование (например, класс \Intervolga\Custom\Exchange\Cml может быть наследником \CIBlockCMLImport и переопределять метод ImportElements).

После правок на сайте нужно изменить параметр «Адрес сайта и путь до скрипта обмена» в 1С. Имя пользователя и пароль одинаковые как для стандартного обмена, так и для доработанного.

Третий способ(через справочники) подходит, если у нужной сущности 1С совсем нет аналога на сайте или по каким-то причинам стандартный импорт совсем не годится. У модуля highloadblock есть все необходимые события (создание, редактирование, удаление) и для ненагруженных проектов это достаточно неплохое решение.

С помощью выгрузки справочников решаются такие задачи, как создание пользователей на сайте через 1С, выгрузка персональных цен и скидок, бонусов и информации для личного кабинета партнеров.

Отладка обмена — отдельный больной вопрос. Обычно решается логированием всех происходящих в недрах Битрикса процессов. В ИНТЕРВОЛГЕ разработали свою систему логирования обмена, которая представляет весь процесс в виде диаграммы Гантта. На ней сразу видно, если идут одновременно 2 обмена или 1С не дожидается ответа и начинает слать новые запросы.

## Заключение

Часто самой сложной задачей в процессе разработки является именно интеграция с 1С. Отчетливое понимание происходящих в Битриксе процессов необходимо для серьезных проектов.

Нужно настроить и доработать интеграцию 1С и сайта? Обращайтесь к нам, мы это умеем.

Хотели бы работать у нас? Мы ищем разработчиков и предлагаем интересные проекты.